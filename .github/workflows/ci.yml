# .github/workflows/ci.yml
name: Pine Mastery CI

on:
  push:
    paths:
      - 'spec_ingest.py'
      - 'specs/**'
      - 'tests/**'
      - '.github/workflows/**'
  workflow_dispatch:

jobs:
  spec-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install requests
        run: pip install requests

      - name: Ingest Pine v6 spec
        run: python spec_ingest.py

      - name: Diff previous and current spec
        run: |
          python - << 'EOF'
          import os, sys, difflib
          SPEC_DIR = "specs"
          files = sorted(f for f in os.listdir(SPEC_DIR)
                         if f.startswith("pine_v6_spec_") and f.endswith(".html"))
          if len(files) < 2:
              print("Only one spec snapshot; skipping diff check.")
              sys.exit(0)
          prev, curr = files[-2], files[-1]
          old = open(f"{SPEC_DIR}/{prev}", encoding="utf-8").read().splitlines()
          new = open(f"{SPEC_DIR}/{curr}", encoding="utf-8").read().splitlines()
          diff = list(difflib.unified_diff(old, new, fromfile=prev, tofile=curr, lineterm=""))
          if diff:
              print(f"ðŸ“˜ Spec changed between {prev} and {curr}:")
              print("\n".join(diff))
              sys.exit(1)
          else:
              print("No changes detected in Pine v6 spec.")
              sys.exit(0)
          EOF

      - name: Generate Pine tests
        run: python tests/generate_tests.py
      - name: Install harvesting deps
        run: pip install requests beautifulsoup4
      - name: Harvest community scripts
        run: python harvest_scripts.py
      - name: List community scripts
        run: |
         echo "Community directory contents:"
                   ls community
      - name: List specs and tests
        run: |
          echo "Specs directory contents:" && ls specs
          echo "Tests directory contents:" && ls tests
      - name: Generate fineâ€‘tune dataset
        run: python generate_finetune_data.py
      - name: Preview fineâ€‘tune dataset
        run: head -n 5 finetune_dataset.jsonl
